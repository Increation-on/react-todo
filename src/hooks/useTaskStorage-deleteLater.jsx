import { useEffect } from "react"
import { useRef } from "react"

export const useTaskStorage = (tasks, dispatch) => {
    // üéØ –°–û–ó–î–ê–Å–ú –§–õ–ê–ì –ü–ï–†–í–û–ì–û –†–ï–ù–î–ï–†–ê
    // useRef —Å–æ–∑–¥–∞—ë—Ç –º—É—Ç–∞–±–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É —Ä–µ–Ω–¥–µ—Ä–∞–º–∏
    // isFirstRender.current = true —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Ä–µ–Ω–¥–µ—Ä–µ
    const isFirstRender = useRef(true)
    
    // üéØ –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –ó–ê–ì–†–£–ó–ö–ò –∑–∞–¥–∞—á –∏–∑ localStorage
    // useEffect –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    useEffect(() => {
        // üéØ –ü–†–û–í–ï–†–Ø–ï–ú: —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä?
        if (isFirstRender.current) {
            // üéØ –ü–û–õ–£–ß–ê–ï–ú –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
            // localStorage.getItem –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –∏–ª–∏ null
            const saved = localStorage.getItem('tasks')
            
            // üéØ –ü–†–û–í–ï–†–Ø–ï–ú: –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –æ–Ω–∏ –Ω–µ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤?
            if (saved && saved !== '[]') {
                // üéØ –ü–†–ï–û–ë–†–ê–ó–£–ï–ú JSON —Å—Ç—Ä–æ–∫—É –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
                // JSON.parse –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç "[]" –≤ [] –∏–ª–∏ "[{...}]" –≤ [{...}]
                const parsed = JSON.parse(saved)
                
                // üéØ –û–¢–ü–†–ê–í–õ–Ø–ï–ú ACTION –≤ —Ä–µ–¥—å—é—Å–µ—Ä
                // dispatch –≥–æ–≤–æ—Ä–∏—Ç —Ä–µ–¥—å—é—Å–µ—Ä—É –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                dispatch({ type: 'LOAD_TASKS', payload: parsed })
            }
            
            // üéØ –ü–ï–†–ï–ö–õ–Æ–ß–ê–ï–ú –§–õ–ê–ì: –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω
            // –¢–µ–ø–µ—Ä—å isFirstRender.current = false –Ω–∞ –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Ä–µ–Ω–¥–µ—Ä–∞—Ö
            isFirstRender.current = false
        }
    }, [dispatch]) // üéØ –ó–ê–í–ò–°–ò–ú–û–°–¢–¨: —ç—Ñ—Ñ–µ–∫—Ç —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –µ—Å–ª–∏ dispatch –∏–∑–º–µ–Ω–∏—Ç—Å—è

    // üéØ –≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –°–û–•–†–ê–ù–ï–ù–ò–Ø –∑–∞–¥–∞—á –≤ localStorage  
    useEffect(() => {
        // üéØ –°–û–•–†–ê–ù–Ø–ï–ú –∑–∞–¥–∞—á–∏ –≤ localStorage
        // JSON.stringify –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫—É
        // –ù–∞–ø—Ä–∏–º–µ—Ä: [{id: 1, text: "–ó–∞–¥–∞—á–∞"}] ‚Üí "[{"id":1,"text":"–ó–∞–¥–∞—á–∞"}]"
        localStorage.setItem('tasks', JSON.stringify(tasks))
    }, [tasks]) // üéØ –ó–ê–í–ò–°–ò–ú–û–°–¢–¨: —ç—Ñ—Ñ–µ–∫—Ç —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ö–ê–ñ–î–û–ú –∏–∑–º–µ–Ω–µ–Ω–∏–∏ tasks
}

// üéØ –ü–†–û–°–¢–´–ú–ò –°–õ–û–í–ê–ú–ò:
// –≠—Ç–æ—Ç —Ö—É–∫ –¥–µ–ª–∞–µ—Ç –¥–≤–µ –≤–µ—â–∏:

//1. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
//2. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

// –ö–∞–∫ –±—É–¥—Ç–æ —É —Ç–µ–±—è –µ—Å—Ç—å –ª–∏—á–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π:
// üì• –ó–∞–ø–æ–º–∏–Ω–∞–µ—Ç –≥–¥–µ —Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è (–∑–∞–≥—Ä—É–∑–∫–∞)
// üì§ –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —á—Ç–æ —Ç—ã —Å–¥–µ–ª–∞–ª (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)